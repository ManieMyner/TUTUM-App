<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tutum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME --- */
        :root {
            --primary: #4FACFE;
            --deep-purple: #432C7A;
            --text-dark: #2D3436;
            --danger: #FF4757;
        }

        body { 
            margin: 0; font-family: 'Fredoka', sans-serif; 
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px; box-sizing: border-box;
        }

        .mobile-frame { 
            width: 100%; max-width: 414px; height: 800px; max-height: 90vh; 
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); border-radius: 35px; border: 6px solid rgba(255,255,255,0.3); background: #F4F7FE;
        }

        @media (max-width: 500px) {
            body { align-items: flex-start; padding: 0; height: 100vh; overflow: hidden; }
            .mobile-frame { width: 100%; height: 100vh; border: none; border-radius: 0; max-height: none; }
        }

        .hidden { display: none !important; }

        /* NOTIFICATION BANNER */
        .notify-banner {
            position: absolute; top: -80px; left: 20px; right: 20px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 15px; transition: top 0.5s; z-index: 2000;
        }
        .notify-banner.show { top: 20px; }
        .notify-icon { width: 40px; height: 40px; background: #E3FCEF; border-radius: 12px; color: #00B894; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* LOGIN SCREEN */
        #screen-login {
            background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            justify-content: center; align-items: center;
            z-index: 1000; position: absolute; top:0; left:0; width:100%; height:100%;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); 
            border: 2px solid rgba(255,255,255,0.4); border-radius: 30px; padding: 30px 20px; width: 80%; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }

        h1.logo-text { font-size: 48px; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); margin: 0 0 10px 0; }
        .slot-input { background: rgba(255,255,255,0.9); border: none; border-radius: 50px; padding: 15px 25px; width: 100%; box-sizing: border-box; margin-bottom: 15px; font-family: 'Fredoka'; font-size: 19px; font-weight: 600; outline: none; }
        
        .btn-3d { 
            background: linear-gradient(to bottom, #4FACFE 0%, #00F2FE 100%); 
            border: none; border-bottom: 6px solid #0099AA; border-radius: 50px; 
            padding: 15px; width: 100%; color: white; font-family: 'Fredoka'; font-size: 20px; font-weight: 700; 
            cursor: pointer; transition: all 0.1s; position: relative; z-index: 1001; 
        }
        .btn-3d:active { transform: translateY(4px); border-bottom: 2px solid #0099AA; }
        .btn-3d:disabled { background: #ccc; border-bottom: 6px solid #999; cursor: not-allowed; transform: none; }

        .role-pill { background: rgba(0,0,0,0.2); border-radius: 50px; display: flex; padding: 5px; margin-bottom: 20px; position: relative; z-index: 1001; }
        .role-opt { flex: 1; padding: 8px; border-radius: 40px; color: rgba(255,255,255,0.7); cursor: pointer; font-weight: 700; }
        .role-opt.active { background: white; color: var(--deep-purple); }

        .text-link { color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 20px; cursor: pointer; text-decoration: underline; font-weight: 600; display: block; position: relative; z-index: 1002; }

        /* APP SCREENS */
        .screen { flex: 1; display: flex; flex-direction: column; background: #F4F7FE; overflow-y: auto; position: absolute; width:100%; height:100%; top:0; left:0; }
        
        .top-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 0 0 30px 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); z-index: 10; }
        .page-title { font-size: 20px; color: var(--deep-purple); font-weight: 700; }
        .icon-btn { font-size: 18px; color: #4FACFE; background: #E6F0FF; width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        
        .logout-btn { color: #FF4757; background: #FFEBE6; }

        .content-area { padding: 20px; padding-bottom: 80px; }
        .bubble-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 4px 0 #E0E6F0; cursor: pointer; transition: 0.1s; border: 1px solid #F0F4F8; }
        .bubble-card:active { transform: translateY(2px); box-shadow: 0 2px 0 #E0E6F0; }
        
        .b-avatar { width: 45px; height: 45px; background: #FFD166; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; margin-right: 15px; position: relative; }
        
        .red-dot { width: 14px; height: 14px; background: #FF4757; border: 2px solid white; border-radius: 50%; position: absolute; top: -5px; right: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; }
        .badge-new { background: #FF4757; color: white; font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 10px; margin-left: auto; }

        .b-info { flex: 1; }
        .b-name { font-weight: 700; color: var(--deep-purple); font-size: 16px; }
        .b-status { font-size: 13px; color: #888; font-weight: 600; }

        .sos-btn { position: absolute; bottom: 25px; right: 20px; width: 65px; height: 65px; background: #FF4757; border-bottom: 5px solid #C41E3A; border-radius: 22px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 16px; box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3); z-index: 50; cursor: pointer; }
        .sos-btn:active { transform: translateY(4px); border-bottom: 2px solid #C41E3A; }

        .chat-feed { flex: 1; padding: 20px; overflow-y: scroll; display: flex; flex-direction: column; gap: 15px; }
        .msg-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-weight: 600; font-size: 16px; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.me { background: #4FACFE; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.them { background: white; color: var(--text-dark); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-img { width: 100%; border-radius: 12px; margin-top: 5px; }

        .input-bar { background: white; padding: 15px; border-top: 1px solid #E0E6F0; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 20px; border-radius: 30px; border: 2px solid #E0E6F0; font-size: 19px; font-family: 'Fredoka'; font-weight: 600; outline: none; }
        .chat-input:focus { border-color: #4FACFE; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .time-box { background: #F0F4F8; padding: 10px; border-radius: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--text-light); }
        input[type="time"] { border: none; background: transparent; font-family: 'Fredoka'; font-weight: bold; font-size: 16px; color: var(--deep-purple); }

        .status-box { padding:15px; border-radius:15px; font-weight:700; font-size:14px; margin-bottom:20px; display:flex; align-items:center; gap:10px; cursor: pointer; transition: 0.1s; }
        .status-unverified { background:#FEE2E2; color:#DC2626; border: 1px solid #DC2626; }
        .status-verified { background:#E3FCEF; color:#00B894; border: 1px solid #00B894; cursor: default; }
        .status-box:active { transform: scale(0.98); }

        .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .scan-line { width: 100%; height: 4px; background: #00F2FE; position: absolute; top: 20%; animation: scan 2s infinite alternate; box-shadow: 0 0 10px #00F2FE; }
        @keyframes scan { from { top: 10%; } to { top: 90%; } }
    </style>
</head>
<body>

<div class="mobile-frame">

    <div id="notify-banner" class="notify-banner">
        <div class="notify-icon"><i class="fas fa-comment-dots"></i></div>
        <div class="notify-content">
            <div id="notify-title" style="font-weight:700; font-size:14px;">New Message</div>
            <div id="notify-msg" style="font-size:12px; color:#636E72;">Sent a photo</div>
        </div>
    </div>

    <div id="screen-login" class="screen">
        <div class="glass-panel">
            <h1 class="logo-text">Tutum</h1>
            <p style="color:#FFF; font-size:14px; margin-bottom:30px; font-weight:600; opacity:0.9;">Your Squad, Your Space.</p>
            <div class="role-pill">
                <div id="role-parent" class="role-opt active" onclick="app.setRole('parent')">Parent</div>
                <div id="role-child" class="role-opt" onclick="app.setRole('child')">Child</div>
            </div>
            
            <div id="form-child" class="hidden">
                <input id="login-user" class="slot-input" placeholder="Username (e.g. teen_user)">
                <button id="btn-login-child" class="btn-3d" onclick="app.login()">Play</button>
            </div>
            
            <div id="form-parent">
                <div id="parent-default">
                    <p style="color:white; font-size:13px; opacity:0.8; margin-bottom:15px;">Parent Dashboard</p>
                    <button id="btn-login-parent" class="btn-3d" style="background: linear-gradient(to bottom, #6C5CE7, #a29bfe);" onclick="app.login()">Login</button>
                    <div class="text-link" onclick="app.toggleInviteMode()">Have an invite code?</div>
                </div>
                
                <div id="parent-invite" class="hidden">
                    <input id="invite-code" class="slot-input" placeholder="Enter Code (e.g. FAM-1234)">
                    <button id="btn-join" class="btn-3d" style="background: linear-gradient(to bottom, #00b894, #55efc4);" onclick="app.joinFamily()">Join Family</button>
                    <div class="text-link" onclick="app.toggleInviteMode()">Back to Login</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-parent" class="screen hidden">
        <div class="top-bar">
            <button class="icon-btn logout-btn" onclick="app.logout()"><i class="fas fa-sign-out-alt"></i></button>
            <div class="page-title">Family Base</div>
            <button class="icon-btn" onclick="app.addChild()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="content-area">
            <div id="verify-box" class="status-box status-unverified" onclick="app.startVerification()">
                <i id="verify-icon" class="fas fa-exclamation-circle"></i><span id="verify-text">Identity Unverified (Tap to Fix)</span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="bubble-card" style="flex:1; justify-content:center; flex-direction:column; text-align:center; padding:20px;" onclick="app.openGuardianChat()">
                    <div class="b-avatar" style="margin:0 auto 10px; background:#6C5CE7;"><i class="fas fa-comments"></i></div>
                    <div class="b-name" style="font-size:14px;">Co-Parent Chat</div>
                </div>
                <div class="bubble-card" style="flex:1; justify-content:center; flex-direction:column; text-align:center; padding:20px;" onclick="app.generateInvite()">
                    <div class="b-avatar" style="margin:0 auto 10px; background:#00b894;"><i class="fas fa-user-plus"></i></div>
                    <div class="b-name" style="font-size:14px;">Invite Spouse</div>
                </div>
            </div>

            <h4 style="margin: 20px 0 10px 5px; color:#a4b0be; text-transform:uppercase; font-size:12px;">Your Kids</h4>
            <div id="children-list"></div>
        </div>
    </div>

    <div id="screen-child-detail" class="screen hidden">
        <div class="top-bar">
            <button class="icon-btn" onclick="app.nav('screen-parent')"><i class="fas fa-chevron-left"></i></button>
            <div class="page-title" id="detail-title">Child</div>
            <div style="width:40px;"></div>
        </div>
        <div class="content-area">
            <h4 style="margin: 0 0 10px 5px; color:#a4b0be; text-transform:uppercase; font-size:12px;">Controls</h4>
            <div class="bubble-card" onclick="app.openSettings()">
                <div class="b-avatar" style="background:#fdcb6e;"><i class="fas fa-moon"></i></div>
                <div class="b-info"><div class="b-name">Curfew</div><div class="b-status">Sleep schedules</div></div>
                <i class="fas fa-chevron-right chevron"></i>
            </div>
            <div class="bubble-card" onclick="app.openParentChat()">
                <div class="b-avatar" style="background:var(--primary);"><i class="fas fa-comments"></i></div>
                <div class="b-info"><div class="b-name">Messages</div><div class="b-status">Chat with child</div></div>
                <div id="msg-badge" class="badge-new hidden">NEW</div>
                <i class="fas fa-chevron-right chevron" style="margin-left: 10px;"></i>
            </div>
            <h4 style="margin: 20px 0 10px 5px; color:#a4b0be; text-transform:uppercase; font-size:12px;">Activity</h4>
            <div id="activity-log"></div>
        </div>
    </div>

    <div id="screen-child-home" class="screen hidden">
        <div class="top-bar">
            <button class="icon-btn logout-btn" onclick="app.logout()"><i class="fas fa-sign-out-alt"></i></button>
            <div class="page-title">My Squad</div>
            <button class="icon-btn" onclick="app.showQR()"><i class="fas fa-qrcode"></i></button>
        </div>
        <div class="content-area">
            <div class="bubble-card" onclick="app.openChat('AI_Tutor', 'Tutor Tom')">
                <div class="b-avatar" style="background:#a29bfe;"><i class="fas fa-robot"></i></div>
                <div class="b-info"><div class="b-name">Tutor Tom</div><div class="b-status" style="color:#6C5CE7; font-weight:800;">Homework Helper</div></div>
            </div>
            <div class="bubble-card" onclick="app.openChat('ParentUser', 'Mom & Dad')">
                <div class="b-avatar" style="background:#0984e3;">
                    <div id="child-badge-parent" class="red-dot hidden"></div>
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="b-info"><div class="b-name">Mom & Dad</div><div class="b-status">Family Base</div></div>
            </div>
        </div>
        <div class="sos-btn" onclick="app.triggerSOS()">SOS</div>
    </div>

    <div id="screen-chat" class="screen hidden">
        <div class="top-bar">
            <button class="icon-btn" onclick="app.back()"><i class="fas fa-chevron-left"></i></button>
            <div class="page-title" id="chat-title">Chat</div>
            <div style="width:40px;"></div>
        </div>
        <div class="chat-feed" id="chat-feed"></div>
        <div class="input-bar">
            <input type="file" id="file-upload" accept="image/*" style="display:none;" onchange="app.sendImage()">
            <button onclick="document.getElementById('file-upload').click()" style="width:40px; height:40px; background:#dfe6e9; border:none; border-radius:50%; color:#636e72; cursor:pointer; margin-right:5px;"><i class="fas fa-camera"></i></button>
            <input id="msg-input" class="chat-input" placeholder="Type here..." autocomplete="off">
            <button onclick="app.send()" style="width:45px; height:45px; background:#4FACFE; border:none; border-radius:50%; color:white; cursor:pointer; margin-left:10px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="overlay-qr" class="hidden overlay" style="background:rgba(45, 52, 54, 0.9);">
        <div style="background:white; padding:30px; border-radius:30px; text-align:center;">
            <img id="qr-img" src="" width="180">
            <h2 id="qr-name">@user</h2>
            <button class="btn-3d" style="margin-top:20px;" onclick="app.closeOverlays()">Close</button>
        </div>
    </div>
    <div id="overlay-scan" class="hidden overlay" style="background:rgba(0,0,0,0.9);">
        <div style="width:250px; height:350px; border:2px solid white; border-radius:20px; position:relative; overflow:hidden; background:rgba(255,255,255,0.1);">
            <div class="scan-line"></div>
            <div style="color:white; text-align:center; margin-top:150px; font-weight:bold;">SCANNING ID...</div>
        </div>
        <p style="color:#aaa; margin-top:20px;">Align document in frame</p>
    </div>
    <div id="overlay-sos" class="hidden overlay" style="background:#FF7675;">
        <i class="fas fa-exclamation-circle" style="font-size:80px; margin-bottom:20px; color:white;"></i>
        <h1 style="color:white;">ALERT SENT!</h1>
        <button class="btn-3d" style="background:white; color:#FF7675; width:60%; margin-top:40px;" onclick="app.closeOverlays()">I'm Safe</button>
    </div>

    <div id="screen-settings" class="screen hidden">
        <div class="top-bar">
            <button class="icon-btn" onclick="app.nav('screen-child-detail')"><i class="fas fa-times"></i></button>
            <div class="page-title">Curfew</div>
            <button class="icon-btn" onclick="app.saveSettings()"><i class="fas fa-check"></i></button>
        </div>
        <div class="content-area">
            <div class="bubble-card" style="cursor:default;">
                <div class="b-info"><div class="b-name">Enable Curfew</div><div class="b-status">Block friends at night</div></div>
                <input type="checkbox" id="curfew-toggle" style="transform: scale(1.5); accent-color: var(--primary);">
            </div>
            <h4 style="margin: 20px 0 10px 5px; color:#a4b0be; text-transform:uppercase; font-size:12px;">Schedule</h4>
            <div class="time-box"><span>Start Time</span><input type="time" id="time-start"></div>
            <div class="time-box" style="margin-top:10px;"><span>End Time</span><input type="time" id="time-end"></div>
        </div>
    </div>

</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    let socket;
    try {
        socket = io();
    } catch(e) {
        console.error("Connection Error", e);
        alert("Server connection failed. Please refresh.");
    }

    let currentUser = "";
    let isParent = true;
    let currentChat = "";
    let chatHistory = [];
    let children = [];
    let selectedChildId = null;
    let parentVerified = false;

    const app = {
        setRole: (role) => {
            isParent = (role === 'parent');
            document.getElementById('role-parent').className = isParent ? 'role-opt active' : 'role-opt';
            document.getElementById('role-child').className = !isParent ? 'role-opt active' : 'role-opt';
            if(isParent) {
                document.getElementById('form-parent').classList.remove('hidden');
                document.getElementById('form-child').classList.add('hidden');
            } else {
                document.getElementById('form-parent').classList.add('hidden');
                document.getElementById('form-child').classList.remove('hidden');
            }
        },

        toggleInviteMode: () => {
            document.getElementById('parent-default').classList.toggle('hidden');
            document.getElementById('parent-invite').classList.toggle('hidden');
        },

        joinFamily: () => {
            const code = document.getElementById('invite-code').value;
            if(!code) return alert("Enter code");
            socket.emit('join family', code);
        },

        login: () => {
            try {
                const btn = isParent ? document.getElementById('btn-login-parent') : document.getElementById('btn-login-child');
                if(btn) { btn.innerText = "Connecting..."; btn.disabled = true; }

                if(isParent) {
                    currentUser = "ParentUser";
                    socket.emit('parent login'); 
                } else {
                    const user = document.getElementById('login-user').value;
                    if(!user) { alert("Please enter username"); app.resetBtn(); return; }
                    socket.emit('child login', user);
                }
            } catch(e) {
                alert("Login Error: " + e.message);
                app.resetBtn();
            }
        },

        resetBtn: () => {
            document.getElementById('btn-login-parent').innerText = "Login";
            document.getElementById('btn-login-parent').disabled = false;
            document.getElementById('btn-login-child').innerText = "Play";
            document.getElementById('btn-login-child').disabled = false;
        },

        logout: () => window.location.reload(),

        nav: (id) => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        },

        back: () => {
             if(isParent && currentChat) {
                 // Check if it was guardian chat or child chat
                 if(currentChat === 'GuardianRoom') app.nav('screen-parent');
                 else app.nav('screen-child-detail');
             }
             else app.nav(isParent ? 'screen-parent' : 'screen-child-home');
        },

        addChild: () => {
            const name = prompt("Name:");
            const user = prompt("Username:");
            if(name && user) socket.emit('register child', { name, username: user });
        },

        startVerification: () => {
            if(parentVerified) return; 
            document.getElementById('overlay-scan').classList.remove('hidden');
            socket.emit('verify identity');
        },
        updateVerifyUI: () => {
            const box = document.getElementById('verify-box');
            box.className = "status-box status-verified";
            document.getElementById('verify-icon').className = "fas fa-check-circle";
            document.getElementById('verify-text').innerText = "Identity Verified";
            document.getElementById('overlay-scan').classList.add('hidden');
        },

        generateInvite: () => {
            socket.emit('generate invite');
        },

        openChildDetail: (id) => {
            selectedChildId = id;
            const child = children.find(c => c.id === id);
            document.getElementById('detail-title').innerText = child.name;
            app.renderActivity(child);
            app.updateDetailBadge();
            app.nav('screen-child-detail');
        },

        updateDetailBadge: () => {
            const child = children.find(c => c.id === selectedChildId);
            if(child && child.unread) {
                document.getElementById('msg-badge').classList.remove('hidden');
            } else {
                document.getElementById('msg-badge').classList.add('hidden');
            }
        },

        openParentChat: () => {
            const child = children.find(c => c.id === selectedChildId);
            if(child) {
                child.unread = false; 
                app.updateDetailBadge();
                app.renderChildrenList();
                app.openChat(child.username, child.name);
            }
        },

        openGuardianChat: () => {
            app.openChat('GuardianRoom', 'Co-Parent Chat');
        },

        renderActivity: (child) => {
             const list = document.getElementById('activity-log');
             list.innerHTML = '';
             if(child.activityLog.length === 0) list.innerHTML = '<div style="color:#aaa; text-align:center;">No activity</div>';
             child.activityLog.forEach(log => {
                const div = document.createElement('div');
                div.className = 'bubble-card';
                div.innerHTML = `
                    <div class="b-avatar" style="${log.type==='alert'?'background:#FF4757':'background:#ccc'}"><i class="fas fa-info"></i></div>
                    <div class="b-info"><div class="b-name">${log.user}</div><div class="b-status">${log.text}</div></div>
                `;
                list.appendChild(div);
             });
        },

        openChat: (id, name) => {
            currentChat = id;
            document.getElementById('chat-title').innerText = name;
            if(id === 'ParentUser') document.getElementById('child-badge-parent').classList.add('hidden');
            const feed = document.getElementById('chat-feed');
            feed.innerHTML = '';
            
            chatHistory.forEach(msg => {
                // Guardian Room Logic
                if (id === 'GuardianRoom') {
                    if (msg.recipient === 'GuardianRoom') app.renderMsg(msg);
                } 
                // Private Chat Logic
                else {
                    if ((msg.sender === currentUser && msg.recipient === currentChat) || 
                        (msg.sender === currentChat && msg.recipient === currentUser)) {
                        app.renderMsg(msg);
                    }
                }
            });
            app.nav('screen-chat');
        },

        send: () => {
            const txt = document.getElementById('msg-input').value;
            if(txt) {
                if(currentChat === 'AI_Tutor') {
                    socket.emit('tutor message', { sender: currentUser, text: txt });
                } else {
                    socket.emit('chat message', { sender: currentUser, recipient: currentChat, text: txt });
                }
                document.getElementById('msg-input').value = '';
            }
        },

        sendImage: () => {
            const file = document.getElementById('file-upload').files[0];
            if(file) {
                if(file.size > 1000000) { alert("Image too big!"); return; }
                const reader = new FileReader();
                reader.onload = function(evt) {
                    socket.emit('chat message', { 
                        sender: currentUser, 
                        recipient: currentChat, 
                        image: evt.target.result 
                    });
                };
                reader.readAsDataURL(file);
                document.getElementById('file-upload').value = "";
            }
        },

        renderMsg: (msg) => {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            const isMe = msg.sender === currentUser;
            div.className = `msg-bubble msg ${isMe ? 'me' : 'them'}`;
            if(msg.image) div.innerHTML = `<img src="${msg.image}" class="chat-img">`;
            else div.innerText = msg.text;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        },

        showQR: () => {
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${currentUser}`;
            document.getElementById('qr-name').innerText = "@"+currentUser;
            document.getElementById('overlay-qr').classList.remove('hidden');
        },

        triggerSOS: () => {
            document.getElementById('overlay-sos').classList.remove('hidden');
            socket.emit('sos signal', currentUser);
        },

        closeOverlays: () => {
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        },

        openSettings: () => {
            const child = children.find(c => c.id === selectedChildId);
            if(child) {
                document.getElementById('curfew-toggle').checked = child.curfew.enabled;
                document.getElementById('time-start').value = child.curfew.start;
                document.getElementById('time-end').value = child.curfew.end;
                app.nav('screen-settings');
            }
        },
        saveSettings: () => {
            const settings = {
                enabled: document.getElementById('curfew-toggle').checked,
                start: document.getElementById('time-start').value,
                end: document.getElementById('time-end').value
            };
            socket.emit('update settings', { childId: selectedChildId, curfew: settings });
            app.nav('screen-child-detail');
        },

        renderChildrenList: () => {
            const list = document.getElementById('children-list');
            list.innerHTML = '';
            children.forEach(c => {
                const div = document.createElement('div');
                div.className = 'bubble-card';
                div.onclick = () => app.openChildDetail(c.id);
                
                const isSOS = c.status && c.status.includes("SOS");
                const showRedDot = c.unread ? '<div class="red-dot"></div>' : '';

                div.innerHTML = `
                    <div class="b-avatar" style="${isSOS ? 'background:#FF4757' : 'background:#a29bfe'}">
                        ${showRedDot}
                        <i class="fas ${isSOS ? 'fa-exclamation' : 'fa-user-astronaut'}"></i>
                    </div>
                    <div class="b-info">
                        <div class="b-name">${c.name}</div>
                        <div class="b-status" style="${isSOS ? 'color:#FF4757' : ''}">${c.status}</div>
                    </div>
                    <i class="fas fa-chevron-right chevron"></i>
                `;
                list.appendChild(div);
            });
        },

        showBanner: (title, text) => {
            const banner = document.getElementById('notify-banner');
            document.getElementById('notify-title').innerText = title;
            document.getElementById('notify-msg').innerText = text;
            banner.classList.add('show');
            setTimeout(() => { banner.classList.remove('show'); }, 4000);
        }
    };

    if(socket) {
        socket.on('update children list', (data) => {
            const oldChildren = children;
            children = data;
            children.forEach(newChild => {
                const old = oldChildren.find(c => c.id === newChild.id);
                if(old && old.unread) newChild.unread = true;
            });
            app.renderChildrenList();
            if(selectedChildId) {
                 const currentChild = children.find(c => c.id === selectedChildId);
                 if(currentChild) app.renderActivity(currentChild);
            }
        });

        socket.on('verification complete', () => {
            parentVerified = true;
            app.updateVerifyUI();
            alert("Success! Your identity has been verified.");
        });

        socket.on('invite code', (code) => {
            alert("INVITE CODE:\n" + code + "\n\nGive this to your co-parent!");
        });

        socket.on('chat message', (msg) => {
            chatHistory.push(msg);
            
            // PARENT NOTIFICATION LOGIC
            // 1. Child to Parent
            if (msg.sender !== currentUser && msg.recipient === currentUser) {
                if(msg.sender !== 'AI_Tutor') app.showBanner("New Message", `From: ${msg.sender}`);
                if (document.getElementById('screen-chat').classList.contains('hidden')) {
                    const child = children.find(c => c.username === msg.sender);
                    if(child) {
                        child.unread = true;
                        app.renderChildrenList();
                        app.updateDetailBadge();
                    }
                    if(msg.sender === 'ParentUser') document.getElementById('child-badge-parent').classList.remove('hidden');
                }
            }
            // 2. Guardian Chat Notification
            if (msg.recipient === 'GuardianRoom' && currentUser === 'ParentUser' && msg.sender !== 'ParentUser') {
                 if(document.getElementById('screen-chat').classList.contains('hidden')) {
                     app.showBanner("Co-Parent", msg.text);
                 }
            }

            if(!document.getElementById('screen-chat').classList.contains('hidden')) {
                 // Check if message belongs in current room
                 if(currentChat === 'GuardianRoom') {
                     if(msg.recipient === 'GuardianRoom') app.renderMsg(msg);
                 } else {
                     if((msg.sender === currentUser && msg.recipient === currentChat) ||
                       (msg.sender === currentChat && msg.recipient === currentUser)) {
                        app.renderMsg(msg);
                    }
                 }
            }
        });

        socket.on('login success', (user) => {
            currentUser = user.username;
            if(user.role === 'parent') {
                app.nav('screen-parent');
                socket.emit('get children');
            } else {
                app.nav('screen-child-home');
            }
            app.resetBtn();
        });

        socket.on('toast', (t) => alert(t));
        
        socket.on('login failed', (t) => {
            alert(t);
            app.resetBtn();
        });
    }
</script>
</body>
</html>
